var $=require("jquery"),jsdom=require("jsdom"),express=require("express"),app=express(),webPush=require("web-push"),bodyParser=require("body-parser"),vehicleRef,refreshInterval;const vapidKeys=webPush.generateVAPIDKeys(),API_KEY="AE9887";app.use(express.static(__dirname+"/")),app.use(bodyParser.json()),app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, Content-Type, Accept"),b.header("Content-Type","application/json"),b.header("Access-Control-Allow-Credentials",!0),c()}),app.get("/getPublicKey",function(a,b){b.json({key:vapidKeys.publicKey})}),app.post("/register",function(a,b){b.sendStatus(201)}),app.post("/sendNotification",function(a,b){clearInterval(refreshInterval);const c={endpoint:a.body.endpoint,keys:{p256dh:a.body.key,auth:a.body.authSecret}},d="",e={vapidDetails:{subject:"mailto:cbrbusissues@gmail.com",publicKey:vapidKeys.publicKey,privateKey:vapidKeys.privateKey}};webPush.setGCMAPIKey("135415812168");var f=a.body.busId,g=a.body.busStopId,h="";vehicleRef=a.body.vehicleRef,f<10?f="000"+f.toString():f<100?f="00"+f.toString():f<1e3&&(f="0"+f.toString()),h='<?xml version="1.0" encoding="iso-8859-1" standalone="yes"?>',h+='<Siri version="2.0" xmlns:ns2="http://www.ifopt.org.uk/acsb" xmlns="http://www.siri.org.uk/siri" xmlns:ns4="http://datex2.eu/schema/2_0RC1/2_0" xmlns:ns3="http://www.ifopt.org.uk/ifopt">',h+="<ServiceRequest>",h+="<RequestTimestamp>"+(new Date).toISOString()+"</RequestTimestamp>",h+="<RequestorRef>AE9887</RequestorRef>",h+='<VehicleMonitoringRequest version="2.0">',h+="<RequestTimestamp>"+(new Date).toISOString()+"</RequestTimestamp>",h+="<VehicleMonitoringRef>VM_ACT_"+f+"</VehicleMonitoringRef>",h+="</VehicleMonitoringRequest>",h+="</ServiceRequest>",h+="</Siri>",jsdom.env("",["http://code.jquery.com/jquery.min.js"],function(a,b){var f=b.$;f.support.cors=!0,refreshInterval=setInterval(function(){f.ajax({url:"https://cors-anywhere.herokuapp.com/http://siri.nxtbus.act.gov.au:11000/AE9887/vm/service.xml",data:h,type:"POST",contentType:"text/xml",dataType:"text",success:function(a){var k,n,o,b=f.parseXML(a),h=f(b),i=!1,j=h.find("VehicleActivity");f.each(j,function(a,b){if(k=f(b),n=k.find("OnwardCall"),o=f(n).find("StopPointRef"),void 0!=o[0]&&void 0!=vehicleRef[0]&&Number(o[0].innerHTML)==Number(g))return i=!0,!1}),i&&(clearInterval(refreshInterval),webPush.sendNotification(c,d,e))},error:function(a){console.log(a)}})},1e4)}),b.send("OK")}),app.listen(process.env.PORT||8888,function(){});