var $=require("jquery"),jsdom=require("jsdom"),express=require("express"),app=express(),webPush=require("web-push"),bodyParser=require("body-parser"),vehicleRef,refreshInterval;const vapidKeys=webPush.generateVAPIDKeys(),API_KEY="AE9887",GCM_API_KEY="AAAAKoN0_ck:APA91bHMOpXH94yl1uFw_iJBblXnB5ufZBg1nF5qxlNuJd2mfotdBoEQtebv_0BxAYQiSgqWid3eRufXij7-396kXwYhum_V-hKXBrGUjWPBAEtvGCMKzioFlzxRBPYwOXRXcGk-limV";webPush.setGCMAPIKey(GCM_API_KEY),webPush.setVapidDetails("mailto:cbrbusissues@gmail.com",vapidKeys.publicKey,vapidKeys.privateKey),app.use(express.static(__dirname+"/")),app.use(bodyParser.json()),app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, Content-Type, Accept"),b.header("Content-Type","application/json"),b.header("Access-Control-Allow-Credentials",!0),c()}),app.get("/getPublicKey",function(a,b){b.json({key:vapidKeys.publicKey})}),app.post("/register",function(a,b){b.sendStatus(201)}),app.post("/sendNotification",function(a,b){clearInterval(refreshInterval);const c={endpoint:a.body.endpoint,keys:{auth:a.body.authSecret,p256dh:a.body.key}},d={gcmAPIKey:GCM_API_KEY,TTL:0};var e=a.body.busId,f=a.body.busStopId,g="";vehicleRef=a.body.vehicleRef,e<10?e="000"+e.toString():e<100?e="00"+e.toString():e<1e3&&(e="0"+e.toString());var h=e.toString()+","+vehicleRef.toString();g='<?xml version="1.0" encoding="iso-8859-1" standalone="yes"?>',g+='<Siri version="2.0" xmlns:ns2="http://www.ifopt.org.uk/acsb" xmlns="http://www.siri.org.uk/siri" xmlns:ns4="http://datex2.eu/schema/2_0RC1/2_0" xmlns:ns3="http://www.ifopt.org.uk/ifopt">',g+="<ServiceRequest>",g+="<RequestTimestamp>"+(new Date).toISOString()+"</RequestTimestamp>",g+="<RequestorRef>AE9887</RequestorRef>",g+='<VehicleMonitoringRequest version="2.0">',g+="<RequestTimestamp>"+(new Date).toISOString()+"</RequestTimestamp>",g+="<VehicleMonitoringRef>VM_ACT_"+e+"</VehicleMonitoringRef>",g+="</VehicleMonitoringRequest>",g+="</ServiceRequest>",g+="</Siri>",jsdom.env("",["http://code.jquery.com/jquery.min.js"],function(a,e){var i=e.$;i.support.cors=!0,refreshInterval=setInterval(function(){i.ajax({url:"https://cors-anywhere.herokuapp.com/http://siri.nxtbus.act.gov.au:11000/AE9887/vm/service.xml",data:g,type:"POST",contentType:"text/xml",dataType:"text",success:function(a){var l,o,p,e=i.parseXML(a),g=i(e),j=!1,k=g.find("VehicleActivity");i.each(k,function(a,b){if(l=i(b),o=l.find("OnwardCall"),p=i(o).find("StopPointRef"),void 0!=p[0]&&void 0!=vehicleRef[0]&&Number(p[0].innerHTML)==Number(f))return j=!0,!1}),j&&(clearInterval(refreshInterval),webPush.sendNotification(c,h,d).then(function(){b.sendStatus(201)}).catch(function(a){console.log(a),b.sendStatus(a.statusCode)}))},error:function(a){console.log(a)}})},1e4)})}),app.listen(process.env.PORT||8888,function(){});