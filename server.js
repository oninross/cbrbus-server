var $=require("jquery"),jsdom=require("jsdom"),express=require("express"),app=express(),webPush=require("web-push"),bodyParser=require("body-parser"),vehicleRef,refreshInterval;const vapidKeys={publicKey:"BICxnXBM_YNm-XbMG2OWfotUv4roMv7yxsXiowl0QDYs8ERPPlUd4A1Tcd8S3sXI7WneX9c2mh1xxNAdIjKzy0I",privateKey:"YQsK3rEMKv_RpectJAKZLpT1KxzQplVsLxSHxJ7dGP8"},API_KEY="AE9887";app.use(express.static(__dirname+"/")),app.use(bodyParser.json()),app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, Content-Type, Accept"),b.header("Content-Type","application/json"),b.header("Access-Control-Allow-Credentials",!0),c()}),app.post("/register",function(a,b){b.sendStatus(201)}),app.post("/sendNotification",function(a,b){clearInterval(refreshInterval);const c={endpoint:a.body.endpoint,keys:{p256dh:a.body.key,auth:a.body.authSecret}},d={vapidDetails:{subject:"mailto:cbrbusissues@gmail.com",publicKey:vapidKeys.publicKey,privateKey:vapidKeys.privateKey}};webPush.setGCMAPIKey("135415812168");var e=a.body.busId,f=a.body.busStopId;vehicleRef=a.body.vehicleRef,e<10?e="000"+e.toString():e<100?e="00"+e.toString():e<1e3&&(e="0"+e.toString()),console.log("sendNotification::"),jsdom.env("",["http://code.jquery.com/jquery.min.js"],function(a,b){var g=b.$;g.support.cors=!0,refreshInterval=setInterval(function(){console.log("refresh::"),g.ajax({url:"https://cors-anywhere.herokuapp.com/http://siri.nxtbus.act.gov.au:11000/AE9887/vm/service.xml",data:'<?xml version="1.0" encoding="iso-8859-1" standalone="yes"?><Siri version="2.0" xmlns:ns2="http://www.ifopt.org.uk/acsb" xmlns="http://www.siri.org.uk/siri" xmlns:ns4="http://datex2.eu/schema/2_0RC1/2_0" xmlns:ns3="http://www.ifopt.org.uk/ifopt"><ServiceRequest><RequestTimestamp>'+(new Date).toISOString()+"</RequestTimestamp><RequestorRef>"+API_KEY+'</RequestorRef><VehicleMonitoringRequest version="2.0"><RequestTimestamp>'+(new Date).toISOString()+"</RequestTimestamp><VehicleMonitoringRef>VM_ACT_"+e+"</VehicleMonitoringRef></VehicleMonitoringRequest></ServiceRequest></Siri>",type:"POST",contentType:"text/xml",dataType:"text",success:function(a){console.log("success::");var k,n,o,p,b=g.parseXML(a),h=g(b),i=!1,j=h.find("VehicleActivity");if(g.each(j,function(a,b){if(k=g(b),n=k.find("StopPointRef"),o=k.find("VehicleRef"),void 0!=n[0]&&void 0!=o[0]&&(console.log(n[0].innerHTML+" == "+f),n[0].innerHTML==f))return i=!0,p=o[0].innerHTML,!1}),i){clearInterval(refreshInterval);var q=[e,p];q=q.toString(),webPush.sendNotification(c,q,d),console.log("Send push notification::")}},error:function(a){console.log(a)}})},1e4)}),b.send("OK")}),app.listen(process.env.PORT||8888,function(){console.log("Example app listening on port 8888!")});