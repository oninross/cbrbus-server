var $=require("jquery"),jsdom=require("jsdom"),express=require("express"),app=express(),webPush=require("web-push"),bodyParser=require("body-parser"),cors=require("cors"),vehicleRef,refreshInterval,vapidKeys={publicKey:"BICxnXBM_YNm-XbMG2OWfotUv4roMv7yxsXiowl0QDYs8ERPPlUd4A1Tcd8S3sXI7WneX9c2mh1xxNAdIjKzy0I",privateKey:"YQsK3rEMKv_RpectJAKZLpT1KxzQplVsLxSHxJ7dGP8"},API_KEY="AE9887";app.use(cors()),app.use(express.static(__dirname+"/")),app.use(bodyParser.json()),app.use(function(e,t,o){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),t.header("Content-Type","application/json"),t.header("Access-Control-Allow-Credentials",!0),o()}),app.get("/getPublicKey",function(e,t){console.log("hello world"),t.json({key:vapidKeys.publicKey})}),app.post("/register",function(e,t){t.sendStatus(201)}),app.post("/sendNotification",function(e,t){clearInterval(refreshInterval);var o={endpoint:e.body.endpoint,keys:{p256dh:e.body.key,auth:e.body.authSecret}},s={vapidDetails:{subject:"mailto:cbrbusissues@gmail.com",publicKey:vapidKeys.publicKey,privateKey:vapidKeys.privateKey}};webPush.setGCMAPIKey("135415812168");var n=e.body.busId,i=e.body.busStopId;vehicleRef=e.body.vehicleRef,n<10?n="000"+n.toString():n<100?n="00"+n.toString():n<1e3&&(n="0"+n.toString()),console.log("sendNotification::"),jsdom.env("",["http://code.jquery.com/jquery.min.js"],function(e,t){var r=t.$;r.support.cors=!0,refreshInterval=setInterval(function(){console.log("refresh::"),r.ajax({url:"https://cors-anywhere.herokuapp.com/http://siri.nxtbus.act.gov.au:11000/"+API_KEY+"/vm/service.xml",data:'<?xml version="1.0" encoding="iso-8859-1" standalone="yes"?><Siri version="2.0" xmlns:ns2="http://www.ifopt.org.uk/acsb" xmlns="http://www.siri.org.uk/siri" xmlns:ns4="http://datex2.eu/schema/2_0RC1/2_0" xmlns:ns3="http://www.ifopt.org.uk/ifopt"><ServiceRequest><RequestTimestamp>'+(new Date).toISOString()+"</RequestTimestamp><RequestorRef>"+API_KEY+'</RequestorRef><VehicleMonitoringRequest version="2.0"><RequestTimestamp>'+(new Date).toISOString()+"</RequestTimestamp><VehicleMonitoringRef>VM_ACT_"+n+"</VehicleMonitoringRef></VehicleMonitoringRequest></ServiceRequest></Siri>",type:"POST",contentType:"text/xml",dataType:"text",success:function(e){console.log("success::");var t,a,p,c,l=r.parseXML(e),u=!1,d=r(l).find("VehicleActivity");if(r.each(d,function(e,o){if(t=r(o),a=t.find("StopPointRef"),p=t.find("VehicleRef"),void 0!=a[0]&&void 0!=p[0]&&(console.log(a[0].innerHTML+" == "+i),a[0].innerHTML==i))return u=!0,c=p[0].innerHTML,!1}),u){clearInterval(refreshInterval);var h=[n,c];h=h.toString(),webPush.sendNotification(o,h,s),console.log("Send push notification::")}},error:function(e){console.log(e)}})},1e4)}),t.send("OK")}),app.options("/getBusPath",function(e,t){t.send("OK")}),app.post("/getBusPath",function(e,t){var o=e.body,s=[];console.log("getBusPath::"),jsdom.env("",["http://code.jquery.com/jquery.min.js"],function(e,n){var i=n.$;i.support.cors=!0,console.log("call"),i.ajax({url:"https://cors-anywhere.herokuapp.com/https://oninross.carto.com/api/v2/sql?q=WITH Q1 AS (SELECT t.shape_id , count(t.shape_id) total FROM routes r INNER JOIN trips t ON t.route_id = r.route_id WHERE r.route_short_name = "+Number(o.busId)+" AND t.direction_id = "+o.busDir+" GROUP BY t.shape_id) SELECT DISTINCT s.* FROM shapes s WHERE s.shape_id IN (SELECT shape_id FROM Q1 WHERE total = (SELECT MAX(total) FROM Q1))&api_key=f35be52ec1b8635c34ec7eab01827bb219750e7c",dataType:"jsonp",contentType:"application/json; charset=utf-8",success:function(e){i.each(e.rows,function(e,t){s.push({lat:t.shape_pt_lat,lng:t.shape_pt_lon})}),console.log("done"),t.json({busCoordinates:s}),t.sendStatus(201)},error:function(e){console.log(e)}})})}),app.listen(process.env.PORT||8888,function(){console.log("Example app listening on port 8888!")});